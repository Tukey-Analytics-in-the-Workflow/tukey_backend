name: Deploy Tukey Backend

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        pip install pytest pytest-cov
        pytest tests/ -v --cov=app --cov-report=xml || true

    - name: Lint with flake8 (optional)
      run: |
        pip install flake8
        flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics || true

    - name: Check API startup
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        pip install uvicorn
        timeout 10 uvicorn app.main:app --host 0.0.0.0 --port 8000 || true
        echo "âœ“ API startup check completed"

    - name: Deploy to production
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        echo "ðŸš€ Deploying Tukey Backend to production..."
        # Option 1: Deploy to Heroku (uncomment and configure if using Heroku)
        # git push https://heroku:${{ secrets.HEROKU_API_KEY }}@git.heroku.com/${{ secrets.HEROKU_APP_NAME }}.git main
        
        # Option 2: Deploy to Azure App Service (uncomment and configure if using Azure)
        # az webapp up --name ${{ secrets.AZURE_APP_NAME }} --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}
        
        # Option 3: Deploy to AWS (uncomment and configure if using AWS)
        # aws elasticbeanstalk create-application-version --application-name tukey-backend --version-label ${{ github.sha }}
        
        # Option 4: Deploy to Docker Registry (uncomment and configure if using Docker)
        # docker build -t tukey-backend:latest .
        # docker tag tukey-backend:latest ${{ secrets.DOCKER_REGISTRY }}/tukey-backend:latest
        # echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
        # docker push ${{ secrets.DOCKER_REGISTRY }}/tukey-backend:latest
        
        echo "âœ“ Deployment ready (configure your deployment target above)"
